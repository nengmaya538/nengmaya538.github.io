{% assign max_related = 6 %}
{% assign count = 0 %}

<div class="related-posts">
  <h2>Related Articles</h2>

  {% assign levels = "5,4,3,2,1" | split: "," %}

  {% for level in levels %}
    {% assign level_num = level | plus: 0 %}

    {% for post in site.posts %}
      {% if post.url != page.url %}

        {% assign score = 0 %}

        {% for cat in page.categories %}
          {% for pcat in post.categories %}
            {% if cat == pcat %}
              {% assign score = score | plus: 1 %}
            {% endif %}
          {% endfor %}
        {% endfor %}

        {% if score == level_num %}

          <div class="related-item">
            <h3>
              <a href="{{ post.url | relative_url }}">
                {{ post.title }}
              </a>
            </h3>

            <div class="excerpt">
              {{ post.content | split: '</p>' | first | append: '</p>' }}
            </div>
          </div>

          {% assign count = count | plus: 1 %}
          {% if count >= max_related %}
            {% break %}
          {% endif %}

        {% endif %}

      {% endif %}
    {% endfor %}

  {% endfor %}
</div>
